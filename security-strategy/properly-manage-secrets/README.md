# Properly Manage Secrets

This is an example of how to treat secrets securely in Kubernetes.

## Requirements

- `helm`
- `kubeseal`

## Sealed Secret

1. Install Sealed Secret

    ```bash
    > helm repo add sealed-secrets https://bitnami-labs.github.io/sealed-secrets
    > helm install sealed-secrets sealed-secrets/sealed-secrets \
        -n kube-system \
        --set-string fullnameOverride=sealed-secrets-controller \
        --version=2.15.3
    ```

2. Create a Sealed Secret manifest

    ```bash
    > kubeseal < secret.yaml --format yaml --name my-sealed-secret > sealed-secrets/my-sealed-secret.yaml
    ```

3. Apply the Sealed Secret manifest

    ```bash
    > kubectl apply -f sealed-secrets/my-sealed-secret.yaml
    ```

4. Check the Sealed Secret

    ```bash
    > kubectl get sealedsecret my-sealed-secret -o yaml # encrypted
    > kubectl get secret my-sealed-secret -o yaml       # decrypted
    ```

## Vault & External Secrets Operator

1. Install Vault

    ```bash
    > helm repo add hashicorp https://helm.releases.hashicorp.com
    > helm install vault hashicorp/vault \
        --set "server.dev.enabled=true" \
        -n vault \
        --create-namespace \
        --version=0.27.0
    ```

2. Enter the Vault pod

    ```bash
    > kubectl exec -it vault-0 -n vault -- /bin/sh
    ```

3. Create a secret in Vault

    ```bash
    > vault kv put secret/config username="user01" password="password01"
    === Secret Path ===
    secret/data/config

    ======= Metadata =======
    Key                Value
    ---                -----
    created_time       2024-12-05T15:26:24.113798962Z
    custom_metadata    <nil>
    deletion_time      n/a
    destroyed          false
    version            1

    > vault kv get secret/config
    === Secret Path ===
    secret/data/config

    ======= Metadata =======
    Key                Value
    ---                -----
    created_time       2024-12-05T15:26:24.113798962Z
    custom_metadata    <nil>
    deletion_time      n/a
    destroyed          false
    version            1

    ====== Data ======
    Key         Value
    ---         -----
    password    password01
    username    user01
    ```

4. Create a Service Account for Authentication

    ```bash
    > kubectl applt -f vault-and-external-secrets-operator/service-account.yaml
    ```

5. Set up the authentication / authorization  of Vault

    ```bash
    > kubectl exec -it vault-0 -n vault -- /bin/sh

    # Authentication
    > vault auth enable kubernetes

    > vault write auth/kubernetes/config \
        kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"

    # Authorization
    > vault policy write app - <<EOF
    path "secret/data/config" {
        capabilities = ["read"]
    }
    EOF

    > vault write auth/kubernetes/role/app \
        bound_service_account_names=vault-auth-sa \
        bound_service_account_namespaces=default \
        policies=app \
        ttl=24h
    ```

6. Install External Secrets Operator

    ```bash
    > helm repo add external-secrets https://charts.external-secrets.io
    > helm repo update
    > helm install external-secrets \
        external-secrets/external-secrets \
        -n external-secrets \
        --create-namespace \
        --version=0.9.16
    ```

7. Create a SecretStore

    ```bash
    > kubectl apply -f vault-and-external-secrets-operator/secret-store.yaml
    ```

8. Create an External Secret

    ```bash
    > kubectl apply -f vault-and-external-secrets-operator/external-secret.yaml
    ```

9. Check the Secret generated by External Secrets Operator

    ```bash
    > kubectl get secret secret-from-external-secret -o yaml
    apiVersion: v1
    data:
    password: cGFzc3dvcmQwMQ==
    username: dXNlcjAx
    ...
    ```
